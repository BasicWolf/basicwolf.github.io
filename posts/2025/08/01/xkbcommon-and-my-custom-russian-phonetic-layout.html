
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Lexend+Deca:wght@100..900&display=swap&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://zaurnasibov.com/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://zaurnasibov.com/theme/pygments/github.min.css">


  <link rel="stylesheet" type="text/css" href="https://zaurnasibov.com/theme/font-awesome/css/fontawesome.min.css">
  <link rel="stylesheet" type="text/css" href="https://zaurnasibov.com/theme/font-awesome/css/brands.min.css">
  <link rel="stylesheet" type="text/css" href="https://zaurnasibov.com/theme/font-awesome/css/solid.min.css">

  <link rel="stylesheet" type="text/css" href="https://zaurnasibov.com//static/css/extra.css">

  <link rel="shortcut icon" href="/static/images/favicon.png" type="image/x-icon">
  <link rel="icon" href="/static/images/favicon.png" type="image/x-icon">


  <link href="https://zaurnasibov.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Zaur's Thoughts Atom">









<meta name="author" content="Zaur Nasibov" />
<meta name="description" content="The Soviet Union officially dissolved in 1991, but Russian language remained the region&#39;s lingua franca for decades. Many children of my generation were simultaneous bilinguals; we spoke both Azeri and Russian since childhood. I learned to type in Russian, but I never ever learned the official Windows Russian keyboard layout, because I didn&#39;t have a keyboard with Russian alphabet printed on it. The alternative was a phonetic layout, and I still remember a program called &#34;Alt-Win&#34;, which allowed to select Azeri Latin, or Russian phonetic keyboard layouts in Windows 9x. Over the years, I used other tools in Windows XP and Windows 7 to recreate this layout. And then I moved to Linux. In Linux, the only tool you need to create your own keyboard layout is a text editor. Would you like to find out how?" />
<meta name="keywords" content="linux, xkb, xkbcommon, wayland, layout, russian, phonetic">


  <meta property="og:site_name" content="Zaur's Thoughts"/>
  <meta property="og:title" content="xkbcommon and my custom Russian phonetic layout"/>
  <meta property="og:description" content="The Soviet Union officially dissolved in 1991, but Russian language remained the region&#39;s lingua franca for decades. Many children of my generation were simultaneous bilinguals; we spoke both Azeri and Russian since childhood. I learned to type in Russian, but I never ever learned the official Windows Russian keyboard layout, because I didn&#39;t have a keyboard with Russian alphabet printed on it. The alternative was a phonetic layout, and I still remember a program called &#34;Alt-Win&#34;, which allowed to select Azeri Latin, or Russian phonetic keyboard layouts in Windows 9x. Over the years, I used other tools in Windows XP and Windows 7 to recreate this layout. And then I moved to Linux. In Linux, the only tool you need to create your own keyboard layout is a text editor. Would you like to find out how?"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://zaurnasibov.com/posts/2025/08/01/xkbcommon-and-my-custom-russian-phonetic-layout.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2025-08-01 12:00:00+03:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="https://zaurnasibov.com/author/zaur-nasibov.html">
  <meta property="article:section" content="Articles"/>
  <meta property="article:tag" content="linux"/>
  <meta property="article:tag" content="xkb"/>
  <meta property="article:tag" content="xkbcommon"/>
  <meta property="article:tag" content="wayland"/>
  <meta property="article:tag" content="layout"/>
  <meta property="article:tag" content="russian"/>
  <meta property="article:tag" content="phonetic"/>
  <meta property="og:image" content="/static/images/logo.png">

  <title>Zaur's Thoughts &ndash; xkbcommon and my custom Russian phonetic layout</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="https://zaurnasibov.com/">
      <img src="/static/images/logo.png" alt="Zaur's Thoughts" title="Zaur's Thoughts">
    </a>

    <h1>
      <a href="https://zaurnasibov.com/">Zaur's Thoughts</a>
    </h1>

    <p>Zaurun Fikirləri</p>


    <nav>
      <ul class="list">

          <li>
            <a target="_self" href="/posts.html" ><strong>Articles</strong></a>
          </li>
          <li>
            <a target="_self" href="/pages/shorts.html" >Shorts</a>
          </li>
          <li>
            <a target="_self" href="/category/books.html" >Books</a>
          </li>


            <li>
              <a target="_self"
                 href="https://zaurnasibov.com/pages/bookmarks.html#bookmarks">
                Bookmarks
              </a>
            </li>
            <li>
              <a target="_self"
                 href="https://zaurnasibov.com/pages/memes.html#memes">
                Memes
              </a>
            </li>
            <li>
              <a target="_self"
                 href="https://zaurnasibov.com/pages/projects.html#projects">
                Projects
              </a>
            </li>
            <li>
              <a target="_self"
                 href="https://zaurnasibov.com/pages/about.html#about">
                About
              </a>
            </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-linkedin"
           href="https://www.linkedin.com/in/zaur-nasibov-44610853/"
           target="_blank">
          <i class="fa-brands fa-linkedin"></i>
        </a>
      </li>
      <li>
        <a class="sc-github"
           href="https://github.com/basicwolf"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
      <li>
        <a class="sc-rss"
           href="/feeds/all.atom.xml"
           target="_blank">
          <i class="fa-solid fa-rss"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>

<nav>
  <a href="https://zaurnasibov.com/">Home</a>

  <a href="/archives.html">Archives</a>
  <a href="/tags.html">Tags</a>
  <a href="/pages/privacy-policy.html">Privacy Policy</a>
</nav>

<article>
  <header>
      
    <h1 id="xkbcommon-and-my-custom-russian-phonetic-layout">xkbcommon and my custom Russian phonetic layout</h1>
    <p>
      Posted on 01 August 2025 in <a href="https://zaurnasibov.com/category/articles.html">Articles</a>

        &#8226; 5 min read
    </p>
  </header>


  <div>
    <p>The Soviet Union officially dissolved in 1991, but Russian language remained
the region's lingua franca for decades.
Many children of my generation were simultaneous bilinguals;
we spoke both Azeri and Russian since childhood.
I learned to type in Russian,
but I never ever learned the official Windows Russian
keyboard layout, because I didn't have a keyboard with Russian alphabet
printed on it.
The alternative was a phonetic layout, and I still remember
a program called &quot;Alt-Win&quot;, which allowed to select Azeri Latin,
or Russian phonetic keyboard layouts in Windows 9x.
Over the years, I used other tools in Windows XP and Windows 7 to recreate
this layout. And then I moved to Linux.</p>
<p>In Linux, the only tool you need to create your own keyboard layout
is a text editor.
Since you are already reading this, scroll down to feed your curiosity!</p>
<img alt="Explain what's in the image" class="align-center" src="https://zaurnasibov.com/articles/2025-08-01-xkbcommon-and-my-custom-phonetic-layout/img/keymap.webp" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In this article, I refer to Russian phonetic keyboard layouts as keyboard
layouts where Russian letters are mostly located at their similarly sounding
letters in English, on US QWERTY keyboard.
For example, the Russian letters &quot;а&quot;, &quot;о&quot;, &quot;м&quot;, &quot;т&quot; are typed using
the English &quot;a&quot;, &quot;o&quot;, &quot;m&quot;, &quot;t&quot; keys.</p>
<p class="last">The trick is to map 33 Russian alphabet letters
to a keyboard that has only 26 Latin letters (used in English)
while retaining the necessary punctuation marks.</p>
</div>
<div class="section" id="custom-layout-the-naive-way">
<h2>Custom layout - the naive way</h2>
<p>The naive way to create a custom layout is by modifying an existing
variant definition in one of the symbols files from <tt class="docutils literal">/usr/share/X11/xkb/symbols</tt>.
That's what I originally did — I modified the <tt class="docutils literal">ru</tt> file and its <tt class="docutils literal">phonetic</tt>
section:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span>partial alphanumeric_keys
xkb_symbols &quot;phonetic&quot; {

    name[Group1]= &quot;Russia - Phonetic&quot;;

    key &lt;TLDE&gt;   {[       Cyrillic_yu,       Cyrillic_YU ]};
    key &lt;AE01&gt;   {[                 1,            exclam ]};
    key &lt;AE02&gt;   {[                 2,                at ]};
    key &lt;AE03&gt;   {[                 3,        numbersign ]};
    ...
    ...
}
</pre></div></td></tr></table></div>
<p>Here, the first column contains the symbolic key names <a class="footnote-reference" href="#footnote-1" id="footnote-reference-1">[1]</a>,
the second column contains the corresponding key symbol for a key pressed
without modifiers,
and the last column contains the key symbol for a key pressed with Shift.</p>
<p>This works, BUT your user needs write permissions for the file,
and the file will be overwritten anyway every time XKB gets updated by the system.</p>
<p>Can you believe that for over 15 years I used the same customised <tt class="docutils literal">ru</tt> symbols
file, and replaced the upstream file over and over?
I did this manually every time the package responsible for <tt class="docutils literal">/usr/share/X11/xkb</tt>
got updated. The file followed me as I moved from Ubuntu to Debian,
and from Debian to Arch. And honestly speaking,
I never bothered to dig deeper and learn the mechanisms behind the command
to set up my desired layouts:</p>
<pre class="literal-block">
setxkbmap -layout 'us,fi,ru,az' -variant ',,phonetic,' -option grp:shifts_toggle
</pre>
<p>That allowed me to cycle through US, Finnish, Russian phonetic and Azeri layouts
by pressing both shifts.</p>
<p>This changed when I installed Arch on
<a class="reference external" href="https://zaurnasibov.com/posts/2025/07/20/framework-laptop-is-awesome.html">my new laptop</a>.
I finally decided to find a &quot;smart way&quot; and learn the mechanisms behind
layouts in Linux graphical environments.</p>
</div>
<div class="section" id="bits-about-xkb">
<h2>Bits about XKB</h2>
<p>Imagine a system with a graphical environment backed by Wayland compositor.
Let's find out how pressing a key on the keyboard results in a symbol appearing
in an application. I'll omit deep technicalities to keep the narrative short.</p>
<div class="figure align-center">
<a class="reference external image-reference" href="https://zaurnasibov.com/articles/2025-08-01-xkbcommon-and-my-custom-phonetic-layout/img/xkb-diagram.svg">
<object data="https://zaurnasibov.com/articles/2025-08-01-xkbcommon-and-my-custom-phonetic-layout/img/xkb-diagram.svg" style="width: 100%;" type="image/svg+xml">Diagram explaining how pressing a keyboard key ends up in application
while passing through libxkbcommon.</object>
</a>
<p class="caption">A high-level diagram of how a key press event travels from a keyboard to
a user-space application.</p>
</div>
<ol class="arabic simple">
<li>Wayland compositor notifies the application about the current keymap
configuration. This happens when application starts or the user changes
keyboard layout.
The application loads the keymap via <strong>xkbcommon</strong> library.</li>
<li>The keyboard device sends a hardware signal - a <em>scancode</em>
to the Linux Kernel.</li>
<li>The kernel's evdev subsystem
maps the scancode to a <em>keycode</em> - a representation abstracted from hardware.</li>
<li>Wayland compositor uses libinput to receive keyboard and other input
device events from the kernel. It notifies the application (a Wayland client)
about a pressed/released key with a <em>keycode</em>, and <em>modifiers</em>.</li>
<li>The application (using GTK, Qt, or other Wayland client implementations)
passes the <em>loaded keymap context</em>, the <em>keycode</em> and <em>modifiers</em> to <strong>xkbcommon</strong>.</li>
<li>xkbcommon applies keycodes/compat/geometry/symbols/types (KcCGST)
configuration <a class="footnote-reference" href="#footnote-2" id="footnote-reference-2">[2]</a>, to map the input to the final symbol.</li>
</ol>
<p>In a nutshell, it's xkbcommon's job to translate
<tt class="docutils literal">Shift + L</tt> keystroke to Cyrillic <tt class="docutils literal">Л</tt> symbol, when I have my Russian
phonetic layout activated.</p>
<p>As Daniel Stone, the maintainer of xkbcommon nicely puts it:</p>
<!--  -->
<blockquote>
It’s about two things: parsing and loading keymaps, and managing their
ongoing state. State, in terms of keyboards, is the usual suspects —
modifiers (e.g. Shift, Alt), multiple layouts (mostly for multiple languages),
and LEDs. In general, you only want one person keeping a canonical copy
of the state, and distributing it to its clients, as both the X server
and Wayland do today.
xkbcommon allows for this mode of operation, and is indeed how all
current Wayland clients handle keyboard input <a class="footnote-reference" href="#footnote-3" id="footnote-reference-3">[3]</a>.</blockquote>
<div class="section" id="historical-reference">
<h3>Historical reference</h3>
<p>X Keyboard Extension (XKB) protocol
was developed in early 1990s and included in
X Window System, Version 11 Release 6 (X11R6) in May 1994 <a class="footnote-reference" href="#footnote-4" id="footnote-reference-4">[4]</a>.
XKB extends the core X protocol by offering support for</p>
<ul class="simple">
<li>Multiple keyboard layouts</li>
<li>Sophisticated modifier handling</li>
<li>LED control</li>
<li>Keyboard geometry description,</li>
<li>Various keyboard behaviors beyond what the core X protocol provides <a class="footnote-reference" href="#footnote-5" id="footnote-reference-5">[5]</a>.</li>
</ul>
<p>Rather than reinventing the wheel, Wayland protocol currently relies on XKB
format for keymaps. Unlike X11, where clients received a symbolic representation
of the key, in Wayland it's up to the clients to interpret keyboard
events and map the pressed keys to symbols.
xkbcommon library is typically used for this purpose.</p>
</div>
</div>
<div class="section" id="custom-layout-the-smart-way">
<h2>Custom layout - the smart way</h2>
<p>The xkbcommon documentation comes with a tutorial on adding a custom
keyboard layout <a class="footnote-reference" href="#footnote-6" id="footnote-reference-6">[6]</a>.
I don't want to repeat that here, and rather encourage you to dive
into it and get the information from the original source.</p>
<p>However, I'll briefly describe my Russian Alternative Phonetic setup.</p>
<ol class="arabic">
<li><div class="first line-block">
<div class="line"><strong>Symbols file:</strong></div>
<div class="line">I placed my custom layout variant in a new symbols file
<tt class="docutils literal"><span class="pre">$HOME/.config/xkb/symbols/ru_alternative</span></tt>.
This file contains translation of symbolic key codes into the desired
key symbols (<a class="reference external" href="https://zaurnasibov.com/articles/2025-08-01-xkbcommon-and-my-custom-phonetic-layout/data/ru_alternative.html">link</a>).</div>
</div>
</li>
<li><div class="first line-block">
<div class="line"><strong>Rules file:</strong></div>
<div class="line">I added a rule to <tt class="docutils literal"><span class="pre">~/.config/xkb/rules/evdev</span></tt> file
(<a class="reference external" href="https://zaurnasibov.com/articles/2025-08-01-xkbcommon-and-my-custom-phonetic-layout/data/evdev.html">link</a>).
The purpose of the rules file is to map between user-friendly configuration,
and the configuration used by <em>xkbcomp</em> keymap compiler <a class="footnote-reference" href="#footnote-7" id="footnote-reference-7">[7]</a>.</div>
</div>
</li>
<li><p class="first">I made the layout discoverable in GNOME by adding an entry to
<tt class="docutils literal"><span class="pre">~/.config/xkb/rules/evdev.xml</span></tt> (<a class="reference external" href="https://zaurnasibov.com/articles/2025-08-01-xkbcommon-and-my-custom-phonetic-layout/data/evdev.xml.html">link</a>).</p>
</li>
</ol>
<p>That's it! A simple solution for a single-person machine,
and no more half-baked solutions with broken layouts after
system updates :)</p>
</div>
<div class="section" id="references">
<h2>References</h2>
<table class="docutils footnote" frame="void" id="footnote-1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-1">[1]</a></td><td><a class="reference external" href="https://xkbcommon.org/doc/current/keymap-text-format-v1.html#keycode-def">xkbcommon - The XKB keymap text format, V1 / Keycode</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-2">[2]</a></td><td><a class="reference external" href="https://xkbcommon.org/doc/current/user-configuration.html#rmlvo-vs-kccgst">xkbcommon - RMLVO vs. KcCGST</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-3">[3]</a></td><td><a class="reference external" href="https://www.fooishbar.org/blog/xkbcommon-intro/">xkbcommon: what is it?</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-4">[4]</a></td><td><a class="reference external" href="https://www.x.org/wiki/X11R6/#index16h4">X Window System, Version 11 release 6 (X11R6)</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-5">[5]</a></td><td><a class="reference external" href="https://deepwiki.com/mirror/libX11/5-x-keyboard-extension-(xkb)">DeepWiki - X Keyboard Extensions</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-6">[6]</a></td><td><a class="reference external" href="https://xkbcommon.org/doc/current/user-configuration.html">xkbcommon - User Configuration</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-7">[7]</a></td><td><a class="reference external" href="https://xkbcommon.org/doc/current/rule-file-format.html">xkbcommon - Rule file format</a></td></tr>
</tbody>
</table>
</div>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://zaurnasibov.com/tag/linux.html">linux</a>
      <a href="https://zaurnasibov.com/tag/xkb.html">xkb</a>
      <a href="https://zaurnasibov.com/tag/xkbcommon.html">xkbcommon</a>
      <a href="https://zaurnasibov.com/tag/wayland.html">wayland</a>
      <a href="https://zaurnasibov.com/tag/layout.html">layout</a>
      <a href="https://zaurnasibov.com/tag/russian.html">russian</a>
      <a href="https://zaurnasibov.com/tag/phonetic.html">phonetic</a>
    </p>
  </div>





  <div class="neighbors">
    <a class="btn float-left" href="https://zaurnasibov.com/posts/2025/07/20/framework-laptop-is-awesome.html" title="Framework Laptop is awesome!">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="https://zaurnasibov.com/posts/2025/08/18/atomic-habits.html" title="The Power of Atomic Habits">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>






</article>

<footer>
<p>&copy; 2025 </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Zaur's Thoughts ",
  "url" : "https://zaurnasibov.com",
  "image": "/static/images/logo.png",
  "description": ""
}
</script><script defer
  src='https://static.cloudflareinsights.com/beacon.min.js'
  data-cf-beacon='{"token": "1147ebca9f9247a38190f2958de429a8"}'>
</script>

</body>
</html>